<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>Courses per School (in a District)</title>
<style>

.axis { font: 14px sans-serif; }

.bar {
  fill: steelblue;
}

</style>

</head>

<!--

- based a lot on https://bl.ocks.org/mbostock/3887051

-->

<h1 class='title'>Business vs Computing Course Enrollments</h1>

<p>Enrollments per year, for the entire state, of Business vs Computing Science
courses.</p>

<div>
<svg width="960" height="700"></svg>
</div>

<script src="https://d3js.org/d3.v4.js"></script>

<script>

const DATA_FILE =  '20180823-1732-BrandonCSTaskForce - Sheet3.csv';

/*
- using https://schools.utah.gov/cte/resources/digitalstudies
- and 20180416-1524-BrandonEnrollmentsByGenderEthnicityForBrandon.xlsx, Sheet
  Courses
*/

// maps course codes to type
// may later map to name

const BUS = 'Business';
const CS = 'Computing Science';

// there's a 35020000034 in the file ... ask Brandon
let course_mapping = {
  '32020000150' : { type : BUS },
  '32020000216' : { type : BUS },
  '32020013150' : { type : BUS },
  '32020013216' : { type : BUS },
  '35020000007' : { type : CS },
  '35020000030' : { type : CS },
  '35020000035' : { type : CS },
  '35020000060' : { type : CS },
  '35020013030' : { type : CS },
  '35020013035' : { type : CS }
};


var svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 300, left: 70},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;

// years
let x0 = d3.scaleBand().range([0, width]).paddingInner(0.1);
// actual bars
let x1 = d3.scaleBand().padding(0.05);

let graph = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.csv(DATA_FILE,
function (d, i, c) {
  return {
    year: d.school_year,
    code: d.core_code,
    enrol: +d['Student Enrollment']
  };
},
function(error, data) {

  // tally up enrolments per year and course type
  // (should be able to reasonably easy make it more generic
  //  so later it can, with a few mods., handle per course name)
  function project_data(d) {

    let graph_map = new Map();

    d.forEach(function(d) {

      let type_obj = course_mapping[d.code];
      if (!type_obj) { return; }
      let type = type_obj.type;

      let key = JSON.stringify({year: d.year, type});
      let val = graph_map.get(key);
      if (!val) {
        val = 0;
      }
      graph_map.set(key, val + d.enrol);

    });

    return graph_map;
  }


  let graph_map = project_data(data);

  // "flatten" the Map into an array of objects
  // (again, similar to project_data, can likely make this more generic ...
  //  later make into a function, too)
  let graph_data = []
  for (let entry of graph_map.entries()) {
    let key = JSON.parse(entry[0]);
    let el = {
      year: key.year, 
      type: key.type,
      enrol: entry[1]
    };
    graph_data.push(el);
  }
  graph_data.sort((a,b) => +a.year - +b.year);

  // get just types, or more generically what will be each individual bar
  let bar_type_set = new Set();
  graph_data.forEach(function(d) {
    bar_type_set.add(d.type);
  });
  let bar_type_keys= Array.from(bar_type_set);

  x0.domain(graph_data.map( (d) => d.year ));
  x1.domain(bar_type_keys).rangeRound([0, x0.bandwidth()]);

  graph.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x0));  


});


</script>

</body>
</html>
