<html>

<style>

div.tooltip {
  position: absolute;    
  text-align: center;    
  /*width: 60px;    
  height: 28px;*/
  padding: 2px;    
  font: 12px sans-serif;    
  background: lightsteelblue;    
  border: 0px;                    
  border-radius: 8px;
}

</style>

<head>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="http://colorbrewer2.org/export/colorbrewer.js"></script>
    <style>
    </style>
</head>
<body>
  <h1>Utah School Districts</h1>
  <p>Starting point for map</p>
  <p>Can hover over and see school district names</p>
  <p>Took template from Ben Sullin's Geospatial Pluralsight course, and from
  various examples by Mike Bostock</p>
  <p>(<strike>main issue:  can't get topojson to work, and stuck with
  geojson.  Will need some more fiddling.</strike>  other issue is need a
  different projection so doesn't correspond to roundness of the earth)</p>

<script>

  //Width and height
  let w = window.innerWidth;
  let h = window.innerHeight;

  let tooltip = d3.select('body')
    .append('div')
    .attr('class', 'tooltip')
    .style('opacity', 0);

  //Create SVG element
  let svg = d3.select("body").append("svg");
  svg.attr('width', w);
  svg.attr('height', h);

  //Load in GeoJSON data
  //d3.json("districts-fips.json", function(json) {
  d3.json("districts-new-topo.json", function(error, json) {

    var projection = d3.geoAlbersUsa();

    //Define path generator
    var path = d3.geoPath().projection(projection);

    // this is needed; not quite sure why
    // (from book mentioned below)
    // believe it's due to projection for entire country
    projection
      .scale(1)
      .translate([0,0]);

    // json.objects.districts from console devtools
    var state = topojson.feature(json, json.objects.districts)

    // from 'Learning D3.js 4 Mapping - Second Edition'
    // similar to https://bl.ocks.org/mbostock/4699541
    // compute bounds of a point of interest, then derive scale and translate
    var b = path.bounds(state),
        s = .95 / Math.max((b[1][0] - b[0][0]) / w, (b[1][1] - b[0][1]) / h),
        t = [(w - s * (b[1][0] + b[0][0])) / 2, (h - s * (b[1][1] + b[0][1])) / 2];

    // update the projection to use computed scale and translate....
    // I think for state?
    projection
      .scale(s)
      .translate(t);

    let color = d3.scaleLinear()
      .domain([0,40])
      .range(d3.schemeOrRd[3]);

    let id = 0;
    // Bind data and create one path per GeoJSON feature
    let map = svg.append('g');

    let districts = map.selectAll("path")
      .data(state.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr('stroke', 'white')
        .attr("fill", function(d) {
          return color(id++);
        })
        .on('mouseenter', function(d) {
          tooltip.style('opacity', 0.9);
          tooltip.html(d.properties.NAME)
            .style('left', (d3.event.pageX) + 'px')
            .style('top', (d3.event.pageY) + 'px');
        })

    // comes very close to only removing tooltip when
    // mouse leaves entire state.
    // (if leaves for tooltip, then svg, tooltip'll stick around ...
    // not too bad.  original issue is tooltip "steals" mouse event
    // from g ... sigh)
    map.on('mouseleave', function() {
      if (d3.event.relatedTarget &&
          d3.event.relatedTarget.tagName === 'svg') {
        tooltip.style('opacity', 0);
      }
    });

  });

</script>

    </body>
</html>
